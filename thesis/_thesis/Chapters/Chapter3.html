<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Modelling the dead and what they died from - 3&nbsp; Some notes on the data and the models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<link href="../Chapters/Chapter4.html" rel="next">
<link href="../Chapters/Chapter2.html" rel="prev">
<link href="../assets/favicon.png" rel="icon" type="image/png">
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Some notes on the data and the models</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Modelling the dead and what they died from</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/theorashid/thesis" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="../Modelling-the-dead-and-what-they-died-from.pdf" title="Download PDF" class="sidebar-tool px-1"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">index.html</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Chapters/Chapter2.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Background</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Chapters/Chapter3.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Some notes on the data and the models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Chapters/Chapter4.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Small: Life expectancy trends in England at the MSOA level</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Chapters/Chapter5.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Smaller: Life expectancy inequality in London at the LSOA level</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Chapters/Chapter6.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">And what they died from: cause-specific mortality in England at the district level</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Chapters/Chapter7.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">And when they died from cancer: trends in cancer mortality at the district level in England</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Chapters/Chapter8.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Discussion</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Appendices</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Appendices/AppendixA.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Hex-cartogram of life expectancy in 2019 at the MSOA level</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#counts-of-the-dead" id="toc-counts-of-the-dead" class="nav-link active" data-scroll-target="#counts-of-the-dead"><span class="toc-section-number">3.1</span>  Counts of the dead</a>
  <ul class="collapse">
  <li><a href="#geographies-of-england" id="toc-geographies-of-england" class="nav-link" data-scroll-target="#geographies-of-england"><span class="toc-section-number">3.1.1</span>  Geographies of England</a></li>
  <li><a href="#counts-of-the-living" id="toc-counts-of-the-living" class="nav-link" data-scroll-target="#counts-of-the-living"><span class="toc-section-number">3.1.2</span>  Counts of the living</a></li>
  <li><a href="#deprivation-data" id="toc-deprivation-data" class="nav-link" data-scroll-target="#deprivation-data"><span class="toc-section-number">3.1.3</span>  Deprivation data</a></li>
  <li><a href="#migration-data" id="toc-migration-data" class="nav-link" data-scroll-target="#migration-data"><span class="toc-section-number">3.1.4</span>  Migration data</a></li>
  </ul></li>
  <li><a href="#modelling-the-dead" id="toc-modelling-the-dead" class="nav-link" data-scroll-target="#modelling-the-dead"><span class="toc-section-number">3.2</span>  Modelling the dead</a></li>
  <li><a href="#inference" id="toc-inference" class="nav-link" data-scroll-target="#inference"><span class="toc-section-number">3.3</span>  Inference</a></li>
  <li><a href="#clean-code-and-open-source" id="toc-clean-code-and-open-source" class="nav-link" data-scroll-target="#clean-code-and-open-source"><span class="toc-section-number">3.4</span>  Clean code and open source</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/theorashid/thesis/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-Chapter3" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Some notes on the data and the models</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="counts-of-the-dead" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="counts-of-the-dead"><span class="header-section-number">3.1</span> Counts of the dead</h2>
<p>This thesis is primarily concerned with modelling death rates for small areas in England. This requires two data sources: counts of deaths, and populations counts. The dataset is de-identified civil registration data for all deaths in England from 2002 to 2019. In other words, every death in England from 2002 to 2019.</p>
<p>The data is extracted from the Office for National Statistics (ONS) database and held by SAHSU, which has the required security protocols as individual death records are identifiable data. The data are updated every year and are mostly complete for previous years, but a handful of deaths are registered in later extracts if the ONS have been waiting on coroner’s report to identify underlying cause of death.</p>
<p>Each record comes with information on postcode of residence, allowing us to assign each death into a spatial unit for analysis. For each analysis, deaths were stratified into the following age groups: 0, 1–4, 5–9, 10–14, then 5-year age groups up to 80–84, and 85 years and older. There are also a series of ICD-10 (International Classification of Dieases, Tenth Revision) codes from the death certificate associated with the underlying and contributory causes leading to the death. Here, we focus only on the underlying cause of death, which has been assigned using selection algorithms to improve consistency between doctors <span class="citation" data-cites="UserGuideMortality2022">(<a href="../references.html#ref-UserGuideMortality2022" role="doc-biblioref"><span>“User guide to mortality statistics,”</span> 2022</a>)</span>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../thesis-analysis/thesis_analysis/eda/figures/age_mx.webp" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Age-specific death rates for broad age groups and life expectancy in England from 2002 to 2019.</figcaption><p></p>
</figure>
</div>
<p>Before to fitting any models, it’s good practice to explore the data visually, in this case looking at how total mortality varies over different cross sections: sex, age, space, time.</p>
<div id="fig-ch-3-district" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="../thesis-analysis/thesis_analysis/eda/figures/e0_map_LAD_2002_2019.webp" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;3.1: District-level life expectancy for total deaths from 2002 to 2019.</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../thesis-analysis/thesis_analysis/eda/figures/age_mx.webp" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Age-specific death rates for England based on total deaths from 2002 to 2019.</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../thesis-analysis/thesis_analysis/eda/figures/age_mx_time.webp" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Age-specific death rates for broad age groups and life expectancy in England from 2002 to 2019.</figcaption><p></p>
</figure>
</div>
<p>Look at different cross sections, slice by age, space and time <a href="#fig-ch-3-district">Figure&nbsp;<span>3.1</span></a> By age + sex, log scale, death rates in 2019 Colour geom_tile plot age-specific death rates over time, trans = log Life expectancy male and female over time e0 aggregated 2002-19 by district</p>
<p>Here, we have taken slices, but the aim is to calculate death rates for each sex-age-space-time unit</p>
<section id="geographies-of-england" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="geographies-of-england"><span class="header-section-number">3.1.1</span> Geographies of England</h3>
<p>Having already introduced the term “district” in Figure XXs, I’ll briefly show the lay of the land in terms of geographies used in this thesis. This thesis is concerned only with England, as Scotland, Wales, and Northern Ireland have their own separate deprivation data which are not comparable. The geographies used here in England form a nested hierarchy of spatial units from regions, districts, Middle-layer Super Output Areas (MSOAs), Lower-layer Super Output Areas (LSOAs). The numbers of each of the units are summarised in <a href="#tbl-geography">Table&nbsp;<span>3.1</span></a>.</p>
<div id="tbl-geography" class="anchored">
<table class="table">
<caption>Table&nbsp;3.1: The number of each geographical unit of England used in thesis and their populations in 2019.</caption>
<colgroup>
<col style="width: 12%">
<col style="width: 20%">
<col style="width: 66%">
</colgroup>
<thead>
<tr class="header">
<th>Geography</th>
<th>Number of units</th>
<th>Median (5th - 9th percentile) population in 2019</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>region</td>
<td>9</td>
<td>5,934,037 (3,536336-9,092,877)</td>
</tr>
<tr class="even">
<td>district</td>
<td>314</td>
<td>140,271 (68,238-380,483)</td>
</tr>
<tr class="odd">
<td>MSOA</td>
<td>6791</td>
<td>7985 (5760–11,917)</td>
</tr>
<tr class="even">
<td>LSOA</td>
<td>32844</td>
<td>1620 (1235-2468)</td>
</tr>
</tbody>
</table>
</div>
<p>England is divided into 9 regions (London, North West, West Midlands, etc). Within these regions, there are 314 local authority districts. Districts are administative geographies formed from a mixture of London boroughs, metropolitan and non-metropolitan distrcts, and unitary autorities. They are responsible for local policies, and therefore subject to local government restructuring and bounary changes. For stability, we chose the district boundaries from 2020.</p>
<p>LSOAs are a type of census geography made up of around four or five smaller units called Output Areas (OAs). OAs are the smallest building block for census statistics, with between 40 and 250 households and typically 100 to 625 people, and are designed to have some socioeconomic homogeneity. MSOAs are then comprised of around four or five LSOAs, and these MSOAs fit within district boundaries. OAs, LSOAs, and MSOAs are all statisitcal units are designed by the ONS purely for analysis purposes, so researchers can use spatial units with similar, but small, population sizes. No policies are created using these units <span class="citation" data-cites="2011CensusGeographies2022">(<a href="../references.html#ref-2011CensusGeographies2022" role="doc-biblioref"><span>“2011 <span>Census</span> geographies,”</span> 2022</a>)</span>.</p>
</section>
<section id="counts-of-the-living" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="counts-of-the-living"><span class="header-section-number">3.1.2</span> Counts of the living</h3>
<p>This second data sources we require are populations counts. These are taken from mid-year population estimates of the usual resident population by the ONS <span class="citation" data-cites="MiddleLayerSuper2021 LowerLayerSuper2021">(<a href="../references.html#ref-LowerLayerSuper2021" role="doc-biblioref"><span>“Lower layer <span>Super Output Area</span> population estimates,”</span> 2021</a>; <a href="../references.html#ref-MiddleLayerSuper2021" role="doc-biblioref"><span>“Middle layer <span>Super Output Area</span> population estimates,”</span> 2021</a>)</span>. The ONS estimates inter-censal populations on a rolling basis, updating the previous year’s value using the change in the population in the GP patient registration data as an indicator of the true population change. The LSOA populations are fully consistent with estimates for higher levels in the nested geographical hierarchical including MSOAs, districts, regions and the national total for England <span class="citation" data-cites="PopulationEstimatesOutput2021">(<a href="../references.html#ref-PopulationEstimatesOutput2021" role="doc-biblioref"><span>“Population estimates by output areas, electoral, health and other geographies, <span>England</span> and <span>Wales</span>,”</span> 2021</a>)</span>.</p>
</section>
<section id="deprivation-data" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="deprivation-data"><span class="header-section-number">3.1.3</span> Deprivation data</h3>
<p>We used data for the following measures of socioeconomic deprivation from the English Indices of Deprivation:</p>
<ul>
<li>Income deprivation (referred to as <em>poverty</em> hereafter). The proportion of the geographical population claiming income-related benefits due to being out of work or having low earnings.</li>
<li>Employment deprivation (referred to as <em>unemployment</em> hereafter). The proportion of the relevant population of the geography involuntarily excluded from the labour market due to unemployment, sickness or disability, or caring responsibilities.</li>
<li>Education, skills and training deprivation (referred to as <em>low education</em> hereafter). Lack of attainment and skills, including education attainment levels, school attendance, and language proficiency indicators in the geographical population.</li>
</ul>
<p>The above measures are the three largest contributors to the Index of Multiple Deprivation (IMD), excluding a domain on health that also uses mortality data. The data are produced at the LSOA level <span class="citation" data-cites="EnglishIndicesDeprivation2019">(<a href="../references.html#ref-EnglishIndicesDeprivation2019" role="doc-biblioref"><span>“English indices of deprivation 2019,”</span> 2019</a>)</span>.</p>
<p>IMD data are not available for every year. The analysis period for the thesis is 2002 to 2019, so we used data for these measures for 2004, as data for 2002 were not available, and 2019. The 2004 data on deprivation domains were reported for LSOA boundaries from the 2001 census. We mapped these data to the 2011 census LSOA boundaries by assigning the 2001 LSOA score to all postcodes contained within it, then overlaying the 2011 LSOA boundaries, and averaging the score for all constituent postcodes of each LSOA, to obtain the corresponding score for each 2011 LSOA.</p>
<p>The definition of the indicators can change over time. Further, the indicator used for measuring education, skills and training deprivation (low education) is not directly interpretable because it combines multiple concepts cannot be simply expressed as a proportion of the population. Therefore, we used ranking rather than scores so that comparisons can be made not only across spatial units in a single year, but also across the different years.</p>
<p>The data for geographies larger than LSOAs in <a href="#tbl-geography">Table&nbsp;<span>3.1</span></a> were created by ranking the population-weighted average of scores for all constituent LSOAs, as done previously for districts <span class="citation" data-cites="EnglishIndicesDeprivation2019">(<a href="../references.html#ref-EnglishIndicesDeprivation2019" role="doc-biblioref"><span>“English indices of deprivation 2019,”</span> 2019</a>)</span>.</p>
</section>
<section id="migration-data" class="level3" data-number="3.1.4">
<h3 data-number="3.1.4" class="anchored" data-anchor-id="migration-data"><span class="header-section-number">3.1.4</span> Migration data</h3>
<p>linked migration data <span class="citation" data-cites="vandijkUsingLinkedConsumer2021">van Dijk et al. (<a href="../references.html#ref-vandijkUsingLinkedConsumer2021" role="doc-biblioref">2021</a>)</span></p>
</section>
</section>
<section id="modelling-the-dead" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="modelling-the-dead"><span class="header-section-number">3.2</span> Modelling the dead</h2>
<p>For each chapter, the quantity of interest is the same: mortality in each age group, spatial unit and year. Empirically, death rates can be calculated from observed data as the number of deaths divided by the population in each strata. Formally, using <span class="math inline">\(a\)</span>, <span class="math inline">\(s\)</span>, and <span class="math inline">\(t\)</span> to index age, spatial unit and time respectively, we write <span id="eq-death-rate"><span class="math display">\[
\hat{m}_{ast} = \frac{\text{deaths}_{ast}}{\text{population}_{ast}},
\tag{3.1}\]</span></span> where <span class="math inline">\(\hat{m}_{ast}\)</span> is the death rate. When the number of deaths becomes small, however, the empirical death rate presents an apparent variability from year to year, or from spatial unit to spatial unit, which is larger than the true differences in the risk of death. The problem is exarcerbated for young ages or rare diseases, where the number of deaths might be zero, or for smaller geographical units, where the population might be zero. Thus, we use Bayesian hierarchical models to obtain stable estimates of death rates by sharing information across age groups, spatial units, and years. An added advantage of the Bayesian paradigm is the robust error estimates.</p>
<p>This is a regression task. We simply want to smooth over the data – the models aren’t being used for prediction. We tried to design as complex a model as possible, to capture as much of the true variation in the data as possible using epidemiologcial knowledge to choose plausible effects. In other words, the model is “full”, enough paramaters to capture all the true variability. Models are overspecified, like Bayesian neural networks (AGW paper) The downside of this approach is that more parameters is harder to fit, and fewer parameters, or parsimonious models, makes Bayesian inference easier.</p>
</section>
<section id="inference" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="inference"><span class="header-section-number">3.3</span> Inference</h2>
<p>The decision was made early in the PhD to use Markov chain Monte Carlo (MCMC) sampling methods for inference, as this is the “gold standard” with guarantees that the sequence of samples will asmyptotically converge to the true posterior. Furthermore, the state-of-the-art approximate inference package for spatial models, INLA, scales badly with the number of effects, and hence would struggle with the models of dimensionality in this thesis.</p>
<p>Bayesian models are specified in a probabilistic programming language. The starting point for this project was the <code>NIMBLE</code> package <span class="citation" data-cites="devalpineNIMBLEMCMCParticle2022 devalpineProgrammingModelsWriting2017">(<a href="../references.html#ref-devalpineNIMBLEMCMCParticle2022" role="doc-biblioref">de Valpine et al., 2022</a>, <a href="../references.html#ref-devalpineProgrammingModelsWriting2017" role="doc-biblioref">2017</a>)</span>. <code>NIMBLE</code> uses the BUGS (“Bayesian inference Using Gibbs Sampling”) syntax for defining a hierarchical model, which the group has a lot of experience with, as <code>WinBUGS</code>, one of the earliest software packages for Bayesian analysis, was developed largely in the department for use on SAHSU studies. <code>NIMBLE</code> has an <code>R</code> interface but compiles models to <code>C++</code> for speed and scalability. It also increases the efficiency of Gibbs sampling efficiently by automatically finding conjugate relationships between parameters in the model and marginalising over them wherever possible. An added advantage is that the group has a close relationship with the lead developer of <code>NIMBLE</code>.</p>
<p>Nevertheless, Bayesian inference is difficult to scale, and some of the models in this thesis had in excess of <span class="math inline">\(10^6\)</span> parameters and took <code>NIMBLE</code> between 10 and 14 days to collect enough samples of the posterior. One of the main issues with <code>NIMBLE</code> was that the vast majority of the parameters in the model could not exploit efficient conjugate samplers, and instead used variants of basic Metropolis-Hastings samplers, which, despite numerous efforts at tuning, were inefficient. Although <code>NIMBLE</code> could execute a reasonable number of samples per second, the MCMC chains were struggling to explore the posterior quickly so the <em>effective</em> sample size per second was low. This is a common problem in spatial and spatiotemporal models, where the parameters are correlated by design. To overcome these mixing issues, the chains had to be run for longer and thinned (i.e.&nbsp;take every <span class="math inline">\(n^{\text{th}}\)</span> sample so the Markov chain samples are closer to independent).</p>
<p>I spent a lot of time trying different probabilsitic programming languages across <code>R</code>, <code>python</code> and <code>Julia</code>, in particular packages that implemented the more efficient No U-Turn Sampler (NUTS) <span class="citation" data-cites="rashidProbabilisticprogrammingpackages2022">(<a href="../references.html#ref-rashidProbabilisticprogrammingpackages2022" role="doc-biblioref">Rashid, 2022</a>)</span>. In the end, I settled on <code>NumPyro</code> <span class="citation" data-cites="phanComposableEffectsFlexible2019">(<a href="../references.html#ref-phanComposableEffectsFlexible2019" role="doc-biblioref">Phan et al., 2019</a>)</span> because it was the fastest and inference could be performed on a GPU, rather than CPUs, which is faster for large models <span class="citation" data-cites="laoTfpMcmcModern2020">(<a href="../references.html#ref-laoTfpMcmcModern2020" role="doc-biblioref">Lao et al., 2020</a>)</span>. The major downside was that <code>NumPyro</code> had not been used extensively by the spatial community, so I had to implement the CAR distribution from <a href="Chapter2.html#eq-CAR-prec">Equation&nbsp;<span>2.2</span></a>, which has since been contributed to the source code. Rewriting the model in <code>NumPyro</code> and sampling on a GPU cut the required runtime down to around a day. <code>NumPyro</code> also has built-in methods for approximate variational inference, such as the Laplace approximation, but these failed to converge to sensible values for these models without heavy customisation of variational function, so I stuck with sampling methods.</p>
</section>
<section id="clean-code-and-open-source" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="clean-code-and-open-source"><span class="header-section-number">3.4</span> Clean code and open source</h2>
<p>I am strong believer in open source science, and I have put a lot of attention into open sourcing the code for all analyses during the PhD. With open science, not only do we faciliate the scientific method as our process and results are reviewed scientific method, but we also allow people in the future to easily reuse and build on our models. It can also generate interest from researchers in different fields using similar models and from developers looking to challenge their software on complicated research questions, both of which I have seen first-hand during the course of my studies. The code is clean, version-controlled and follows best practices for scientific software engineering wherever possible. As well as code contributed to open source projects along the way, the code for <a href="https://github.com/theorashid/mortality-statsmodel">statistical models</a>, <a href="https://github.com/theorashid/thesis-analysis">plots and analysis</a>, and the <a href="https://github.com/theorashid/thesis">thesis istelf</a> can be found on GitHub.</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-2011CensusGeographies2022" class="csl-entry" role="doc-biblioentry">
2011 <span>Census</span> geographies. 2022. <em>Office for National Statistics</em>.
</div>
<div id="ref-devalpineNIMBLEMCMCParticle2022" class="csl-entry" role="doc-biblioentry">
de Valpine P, Paciorek CJ, Turek D, Michaud N, Anderson-Bergman C, Obermayer F, Wehrhahn Cortes C, Rodrìguez A, Lang DT, Paganin S, Hug J. 2022. <span>NIMBLE</span>: <span>MCMC</span>, <span>Particle Filtering</span>, and <span>Programmable Hierarchical Modeling</span>.
</div>
<div id="ref-devalpineProgrammingModelsWriting2017" class="csl-entry" role="doc-biblioentry">
de Valpine P, Turek D, Paciorek CJ, Anderson-Bergman C, Lang DT, Bodik R. 2017. Programming <span>With Models</span>: <span>Writing Statistical Algorithms</span> for <span>General Model Structures With NIMBLE</span>. <em>Journal of Computational and Graphical Statistics</em> <strong>26</strong>:403–413. doi:<a href="https://doi.org/10.1080/10618600.2016.1172487">10.1080/10618600.2016.1172487</a>
</div>
<div id="ref-EnglishIndicesDeprivation2019" class="csl-entry" role="doc-biblioentry">
English indices of deprivation 2019. 2019. <em>Ministry of Housing, Communities &amp; Local Government</em>.
</div>
<div id="ref-laoTfpMcmcModern2020" class="csl-entry" role="doc-biblioentry">
Lao J, Suter C, Langmore I, Chimisov C, Saxena A, Sountsov P, Moore D, Saurous RA, Hoffman MD, Dillon JV. 2020. Tfp.mcmc: <span>Modern Markov Chain Monte Carlo Tools Built</span> for <span>Modern Hardware</span>. doi:<a href="https://doi.org/10.48550/arXiv.2002.01184">10.48550/arXiv.2002.01184</a>
</div>
<div id="ref-LowerLayerSuper2021" class="csl-entry" role="doc-biblioentry">
Lower layer <span>Super Output Area</span> population estimates. 2021. <em>Office for National Statistics</em>.
</div>
<div id="ref-MiddleLayerSuper2021" class="csl-entry" role="doc-biblioentry">
Middle layer <span>Super Output Area</span> population estimates. 2021. <em>Office for National Statistics</em>.
</div>
<div id="ref-phanComposableEffectsFlexible2019" class="csl-entry" role="doc-biblioentry">
Phan D, Pradhan N, Jankowiak M. 2019. Composable <span>Effects</span> for <span>Flexible</span> and <span>Accelerated Probabilistic Programming</span> in <span>NumPyro</span>. doi:<a href="https://doi.org/10.48550/arXiv.1912.11554">10.48550/arXiv.1912.11554</a>
</div>
<div id="ref-PopulationEstimatesOutput2021" class="csl-entry" role="doc-biblioentry">
Population estimates by output areas, electoral, health and other geographies, <span>England</span> and <span>Wales</span>. 2021. <em>Office for National Statistics</em>.
</div>
<div id="ref-rashidProbabilisticprogrammingpackages2022" class="csl-entry" role="doc-biblioentry">
Rashid T. 2022. Probabilistic-programming-packages.
</div>
<div id="ref-UserGuideMortality2022" class="csl-entry" role="doc-biblioentry">
User guide to mortality statistics. 2022. <em>Office for National Statistics</em>.
</div>
<div id="ref-vandijkUsingLinkedConsumer2021" class="csl-entry" role="doc-biblioentry">
van Dijk JT, Lansley G, Longley PA. 2021. Using linked consumer registers to estimate residential moves in the <span>United Kingdom</span>. <em>Journal of the Royal Statistical Society: Series A (Statistics in Society)</em> <strong>184</strong>:1452–1474. doi:<a href="https://doi.org/10.1111/rssa.12713">10.1111/rssa.12713</a>
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../Chapters/Chapter2.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Background</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../Chapters/Chapter4.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Small: Life expectancy trends in England at the MSOA level</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>