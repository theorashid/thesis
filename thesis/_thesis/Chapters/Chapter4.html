<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Spatiotemporal mortality modelling - 4&nbsp; Modelling death rates</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<link href="../Chapters/Chapter5.html" rel="next">
<link href="../Chapters/Chapter3.html" rel="prev">
<link href="../assets/favicon.png" rel="icon" type="image/png">
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Chapters/Chapter4.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Modelling death rates</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Spatiotemporal mortality modelling</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/theorashid/thesis" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">index.html</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Chapters/Chapter2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Background</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Chapters/Chapter3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Chapters/Chapter4.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Modelling death rates</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Chapters/Chapter5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Life expectancy trends in England at the MSOA level</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Chapters/Chapter6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Life expectancy inequality in London at the LSOA level</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Chapters/Chapter7.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Cause-specific mortality at the district level</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Chapters/Chapter8.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Trends in cancer mortality at the district level</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Chapters/Chapter9.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Discussion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Appendices/AppendixA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Life table methods</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Appendices/AppendixB.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Model parameters and priors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Appendices/AppendixC.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Hex-cartogram of life expectancy in 2019 at the MSOA level</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Appendices/AppendixD.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Groups of causes of death</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Appendices/AppendixE.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Maps of cause-specific mortality</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">4.1</span> Overview</a></li>
  <li><a href="#why-we-need-to-smooth-death-rates" id="toc-why-we-need-to-smooth-death-rates" class="nav-link" data-scroll-target="#why-we-need-to-smooth-death-rates"><span class="header-section-number">4.2</span> Why we need to smooth death rates</a></li>
  <li><a href="#a-model-for-smoothing-death-rates" id="toc-a-model-for-smoothing-death-rates" class="nav-link" data-scroll-target="#a-model-for-smoothing-death-rates"><span class="header-section-number">4.3</span> A model for smoothing death rates</a></li>
  <li><a href="#inference" id="toc-inference" class="nav-link" data-scroll-target="#inference"><span class="header-section-number">4.4</span> Inference</a></li>
  <li><a href="#clean-code-and-open-source" id="toc-clean-code-and-open-source" class="nav-link" data-scroll-target="#clean-code-and-open-source"><span class="header-section-number">4.5</span> Clean code and open source</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/theorashid/thesis/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-Chapter4" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Modelling death rates</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="overview" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="overview"><span class="header-section-number">4.1</span> Overview</h2>
<p>This chapter presents the modelling choices that are common between the proceeding analysis chapters.</p>
</section>
<section id="why-we-need-to-smooth-death-rates" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="why-we-need-to-smooth-death-rates"><span class="header-section-number">4.2</span> Why we need to smooth death rates</h2>
<p>For each chapter, the quantity of interest is the same: mortality in each age group, spatial unit and year. Empirically, death rates can be calculated from observed data as the number of deaths divided by the population in each strata. Formally, using <span class="math inline">\(a\)</span>, <span class="math inline">\(s\)</span>, and <span class="math inline">\(t\)</span> to index age, spatial unit and time, respectively, we write <span id="eq-death-rate"><span class="math display">\[
\hat{m}_{ast} = \frac{\text{deaths}_{ast}}{\text{population}_{ast}},
\tag{4.1}\]</span></span> where <span class="math inline">\(\hat{m}_{ast}\)</span> is the empirical death rate.</p>
<p>When the number of deaths becomes small, however, the empirical death rate presents an apparent variability from year to year, or from spatial unit to spatial unit, which is larger than the true differences in the risk of death. The problem is exacerbated for the young ages or causes with lower mortality, where the number of deaths might be zero, or for smaller geographical units, where the population might be very small. As a demonstration, <a href="#fig-ch-4-sim">Figure&nbsp;<span>4.1</span></a> shows the expected and simulated number of deaths for a young age group (1-4 years) and an old age group (80-84). The simulation assumes the hypothetical spatial unit has a population of 1000 in each age group in each year, and generates deaths using a Poisson distribution and the national age-specific death rates for each year. Note, given the population sizes in <a href="Chapter3.html#tbl-ch-3-geography">Table&nbsp;<span>3.1</span></a>, the true age-specific populations for LSOAs and MSOAs will be smaller and there will be even more zeros and even more noise in the number of deaths than in this simulation. Although there are a large number of deaths in the older age group and it is easy to visualise a curve that fits the data, the death counts for the young age group are extremely sparse and it is difficult to estimate the true underlying death rate. In this thesis, I have used Bayesian hierarchical models to obtain stable estimates of death rates by sharing information across age groups, spatial units, and years. An added advantage of the Bayesian paradigm is the robust estimation of error.</p>
<div id="fig-ch-4-sim" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="../thesis-analysis/thesis_analysis/eda/figures/age_mx_time_sim.webp" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;4.1: Simulated and expected deaths from 2002 to 2019 for a young age group (1-4 years) and an old age group (80-84 years), assuming the national death rates in England and a population size of 1000.</figcaption>
</figure>
</div>
<p>This is a regression task. We want to smooth over the data – the models are not being used for prediction. I tried to design a model that captures as much of the true variation in the data as possible using epidemiological knowledge to choose plausible effects. In other words, the model is “full”, with enough parameters to capture all the true variability. The downside of this approach is that models with more parameters are harder to fit, whereas models with fewer parameters, or <em>parsimonious</em> models, make Bayesian inference easier but can mask some of the variance.</p>
</section>
<section id="a-model-for-smoothing-death-rates" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="a-model-for-smoothing-death-rates"><span class="header-section-number">4.3</span> A model for smoothing death rates</h2>
<p>Here, I will present the model for smoothing death rates used for the analysis in <a href="Chapter5.html"><span>Chapter&nbsp;5</span></a>. Each chapter thereafter, I will explain how and why the model differs.</p>
<p>I used a Bayesian hierarchical model to obtain stable estimates of death rates by sharing information across age groups, spatial units, and years. I conducted all analyses for women and men separately because mortality and trends differ by sex. In the model, the number of deaths in age group <span class="math inline">\(a (=1,...,19)\)</span>, spatial unit <span class="math inline">\(s (=1,...,6791)\)</span><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> and year <span class="math inline">\(t (= 1,...,18)\)</span> follows a negative binomial distribution <span id="eq-ch-4-likelihood-1"><span class="math display">\[
\text{deaths}_{ast} \sim \text{Negative Binomial}(p_{ast}, r).
\tag{4.2}\]</span></span> The parameter <span class="math inline">\(p_{ast}\)</span> is <span id="eq-ch-4-likelihood-2"><span class="math display">\[
p_{ast} = \frac{r}{r + m_{ast} \cdot \text{Population}_{ast}}.
\tag{4.3}\]</span></span> where <span class="math inline">\(r \geq 0\)</span> is the overdispersion parameter, which accounts for extra variability not captured by other components in the model, and <span class="math inline">\(m_{ast}\)</span> is the death rate. The negative binomial<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> likelihood can be thought of as a generalisation of the Poisson likelihood, which allows for overdispersion, with larger values of <span class="math inline">\(r\)</span> indicating more similarity to a Poisson distribution. A Poisson distribution is a suitable approximation to the binomial distribution for rare events.</p>
<p>Log-transformed death rates were modelled as a function of time, age group and spatial unit. The model contains terms to capture the overall level and trend over time of mortality, as well as age-specific and space-specific terms to allow deviations from these terms. Specifically, log-transformed death rates are modelled as <span id="eq-ch-4-model"><span class="math display">\[
\log({m_{ast}}) = \alpha_0 + \beta_0 t + \alpha_{1s} + \beta_{1s} t + \alpha_{2a} + \beta_{2a} t + \xi_{as} + \nu_{st} + \gamma_{at},
\tag{4.4}\]</span></span> where <span class="math inline">\(\alpha_0\)</span> is the overall intercept across all age groups and spatial units. <span class="math inline">\(\beta_0\)</span> quantifies the overall trend (over time) across all age groups and spatial units. <span class="math inline">\(\alpha_{1s}\)</span> and <span class="math inline">\(\beta_{1s}\)</span> measure deviation from the overall intercept and trend terms, respectively, for each spatial unit. <span class="math inline">\(\alpha_{2a}\)</span> and <span class="math inline">\(\beta_{2a}\)</span> measure deviation from the global level and trend, respectively, for each age group. I used first-order random walk priors on <span class="math inline">\(\alpha_{2a}\)</span> and <span class="math inline">\(\beta_{2a}\)</span> so that they vary smoothly over adjacent age groups, with the form <span class="math inline">\(A_a \sim \mathcal{N}(A_{a-1}, \sigma_A^2)\)</span> for both age-specific terms <span class="math inline">\(\alpha_{2a}\)</span> and <span class="math inline">\(\beta_{2a}\)</span>. I constrained <span class="math inline">\(\alpha_{21} = 0\)</span> and <span class="math inline">\(\beta_{21} = 0\)</span> so each random walk was identifiable and centred on the corresponding overall term.</p>
<p><span class="math inline">\(\xi_{as}\)</span> is an age group-spatial unit interaction term, which quantifies space-specific deviations from the overall age group structure given by <span class="math inline">\(\alpha_{2a}\)</span>. This allows different spatial units to have different age-specific mortality patterns, and each age group’s death rate to have a different spatial pattern. This interaction term was modelled as <span class="math inline">\(\mathcal{N}(0, \sigma_\xi^2)\)</span>.</p>
<p><span class="math inline">\(\nu_{st}\)</span> and <span class="math inline">\(\gamma_{at}\)</span> allow space- and age group-specific nonlinearity in the time trends. For each spatial unit and age group, I again used first-order random walk priors with <span class="math inline">\(\nu_{s1} = \gamma_{a1} = 0\)</span> so that the terms were identifiable.</p>
<p>The spatial intercepts and slopes, <span class="math inline">\(\alpha_{1s}\)</span> and <span class="math inline">\(\beta_{1s}\)</span>, were modelled as nested hierarchical random effects. For the MSOA analysis, MSOAs were nested in districts, which were, in turn, nested in regions. For the LSOA analysis, LSOAs were nested in MSOAs, which were nested in districts. The terms for the largest spatial unit were centred on zero to allow the spatial effects to be identifiable.</p>
<p>All standard deviation parameters of the random effects had <span class="math inline">\(\sigma \sim \mathcal{U}(0, 2)\)</span> priors. For the global intercept and slope, we used the diffuse prior <span class="math inline">\(\mathcal{N}(0, \sigma^2=10^5)\)</span>. The overdispersion parameter <span class="math inline">\(r\)</span> had the prior <span class="math inline">\(\mathcal{U}(0, 50)\)</span>.</p>
<p><a href="../Appendices/AppendixB.html#tbl-ap-ch4-model">Table&nbsp;<span>B.1</span></a> shows all model parameters, their priors and dimensions for the MSOA-level model in <a href="Chapter5.html"><span>Chapter&nbsp;5</span></a>.</p>
</section>
<section id="inference" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="inference"><span class="header-section-number">4.4</span> Inference</h2>
<p>The decision was made early in my PhD research to use Markov chain Monte Carlo (MCMC) sampling methods for inference, as this is the “gold standard” with guarantees that the sequence of samples will asymptotically converge to the true posterior. Furthermore, the state-of-the-art approximate inference package for spatial models, <code>INLA</code>, scales badly with the number of hyperparameters, and hence would struggle with the high dimensionality of the models in this thesis.</p>
<p>Bayesian models can be specified in a probabilistic programming language. The starting point for this project was the <code>NIMBLE</code> package <span class="citation" data-cites="devalpineNIMBLEMCMCParticle2022 devalpineProgrammingModelsWriting2017">(<a href="../references.html#ref-devalpineNIMBLEMCMCParticle2022" role="doc-biblioref">de Valpine et al., 2022</a>, <a href="../references.html#ref-devalpineProgrammingModelsWriting2017" role="doc-biblioref">2017</a>)</span>. <code>NIMBLE</code> uses the BUGS (“Bayesian inference Using Gibbs Sampling”) syntax for defining a hierarchical model, which my research group has a lot of experience with as <code>WinBUGS</code>, one of the earliest software packages for Bayesian analysis, was developed largely in the department for use on SAHSU studies. <code>NIMBLE</code> has an <code>R</code> interface but compiles models to <code>C++</code> for speed and scalability. It also increases the sampling efficiency by automatically finding conjugate relationships between parameters in the model and marginalising over them wherever possible. The group also has a close relationship with the lead developer of <code>NIMBLE</code>.</p>
<p>Nevertheless, Bayesian inference is difficult to scale, and some of the models in this thesis had in excess of <span class="math inline">\(10^6\)</span> parameters and took <code>NIMBLE</code> between 10 and 14 days to collect enough posterior samples. One of the main issues with <code>NIMBLE</code> was that the vast majority of the parameters in the model could not exploit efficient conjugate samplers, and instead used variants of basic Metropolis-Hastings samplers, which, despite numerous efforts at tuning, were inefficient. Although <code>NIMBLE</code> could execute a reasonable number of samples per second, the MCMC chains were struggling to explore the posterior efficiently so the <em>effective</em> sample size per second was low. This is a common problem in spatial and spatiotemporal models, where the parameters are correlated by design. To overcome these mixing issues, the chains had to be run for longer and thinned (i.e.&nbsp;take every <span class="math inline">\(n^{\text{th}}\)</span> sample so the Markov chain samples are closer to independent, which is better for computational reasons than storing a large number of correlated samples).</p>
<p>I tried different probabilistic programming languages across <code>R</code>, <code>python</code> and <code>Julia</code> <span class="citation" data-cites="rashidProbabilisticprogrammingpackages2022">(<a href="../references.html#ref-rashidProbabilisticprogrammingpackages2022" role="doc-biblioref">Rashid, 2022</a>)</span>, in particular packages that implemented the more efficient No U-Turn Sampler (NUTS) <span class="citation" data-cites="hoffmanNoUTurnSamplerAdaptively2014">(<a href="../references.html#ref-hoffmanNoUTurnSamplerAdaptively2014" role="doc-biblioref">Hoffman and Gelman, 2014</a>)</span>. In the end, I settled on <code>NumPyro</code> <span class="citation" data-cites="phanComposableEffectsFlexible2019">(<a href="../references.html#ref-phanComposableEffectsFlexible2019" role="doc-biblioref">Phan et al., 2019</a>)</span> because it was the fastest and inference could be performed on a GPU, rather than CPUs, which is more performant for large models <span class="citation" data-cites="laoTfpMcmcModern2020">(<a href="../references.html#ref-laoTfpMcmcModern2020" role="doc-biblioref">Lao et al., 2020</a>)</span>. The major downside was that <code>NumPyro</code> had not been used extensively by the spatial modelling community so I had to implement the CAR distribution from <a href="Chapter2.html#eq-CAR-prec">Equation&nbsp;<span>2.2</span></a> myself, which has since been contributed to the source code <span class="citation" data-cites="numpyrodocumentationCARDistribution2023">(<a href="../references.html#ref-numpyrodocumentationCARDistribution2023" role="doc-biblioref">NumPyro documentation, 2023</a>)</span>. Rewriting the model in <code>NumPyro</code> and sampling on a GPU cut the runtime down to around a day. <code>NumPyro</code> also has built-in methods for approximate variational inference, such as the Laplace approximation, but these failed to converge to sensible values for these models without heavy customisation of variational function, so I stuck with sampling methods.</p>
</section>
<section id="clean-code-and-open-source" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="clean-code-and-open-source"><span class="header-section-number">4.5</span> Clean code and open source</h2>
<p>I have paid a lot of attention to open sourcing code for all analyses during my PhD. The code is clean, version-controlled and follows best practices for scientific software engineering. As well as code contributed to open source projects along the way, the code for <a href="https://github.com/theorashid/mortality-statsmodel">statistical models</a>, <a href="https://github.com/theorashid/thesis-analysis">plots and analysis</a>, and the <a href="https://github.com/theorashid/thesis">thesis itself</a> can be found on GitHub.</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-devalpineNIMBLEMCMCParticle2022" class="csl-entry" role="listitem">
de Valpine P, Paciorek CJ, Turek D, Michaud N, Anderson-Bergman C, Obermayer F, Wehrhahn Cortes C, Rodrìguez A, Lang DT, Paganin S, Hug J. 2022. <span>NIMBLE</span>: <span>MCMC</span>, <span>Particle Filtering</span>, and <span>Programmable Hierarchical Modeling</span>.
</div>
<div id="ref-devalpineProgrammingModelsWriting2017" class="csl-entry" role="listitem">
de Valpine P, Turek D, Paciorek CJ, Anderson-Bergman C, Lang DT, Bodik R. 2017. Programming <span>With Models</span>: <span>Writing Statistical Algorithms</span> for <span>General Model Structures With NIMBLE</span>. <em>Journal of Computational and Graphical Statistics</em> <strong>26</strong>:403–413. doi:<a href="https://doi.org/10.1080/10618600.2016.1172487">10.1080/10618600.2016.1172487</a>
</div>
<div id="ref-hoffmanNoUTurnSamplerAdaptively2014" class="csl-entry" role="listitem">
Hoffman MD, Gelman A. 2014. The <span>No-U-Turn</span> sampler: Adaptively setting path lengths in <span>Hamiltonian Monte Carlo</span>. <em>Journal of Machine Learning Research</em> <strong>15</strong>:1593–1623. doi:<a href="https://doi.org/10.48550/arXiv.1111.4246">10.48550/arXiv.1111.4246</a>
</div>
<div id="ref-laoTfpMcmcModern2020" class="csl-entry" role="listitem">
Lao J, Suter C, Langmore I, Chimisov C, Saxena A, Sountsov P, Moore D, Saurous RA, Hoffman MD, Dillon JV. 2020. Tfp.mcmc: <span>Modern Markov Chain Monte Carlo Tools Built</span> for <span>Modern Hardware</span>. doi:<a href="https://doi.org/10.48550/arXiv.2002.01184">10.48550/arXiv.2002.01184</a>
</div>
<div id="ref-mcelreathStatisticalRethinking2020" class="csl-entry" role="listitem">
McElreath R. 2020. Statistical <span>Rethinking</span>, 2nd ed. <span>CRC Press</span>.
</div>
<div id="ref-numpyrodocumentationCARDistribution2023" class="csl-entry" role="listitem">
NumPyro documentation. 2023. <span>CAR</span> distribution. <em>NumPyro</em>.
</div>
<div id="ref-phanComposableEffectsFlexible2019" class="csl-entry" role="listitem">
Phan D, Pradhan N, Jankowiak M. 2019. Composable <span>Effects</span> for <span>Flexible</span> and <span>Accelerated Probabilistic Programming</span> in <span>NumPyro</span>. doi:<a href="https://doi.org/10.48550/arXiv.1912.11554">10.48550/arXiv.1912.11554</a>
</div>
<div id="ref-rashidProbabilisticprogrammingpackages2022" class="csl-entry" role="listitem">
Rashid T. 2022. Probabilistic-programming-packages. <em>GitHub</em>.
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>The dimension of <span class="math inline">\(s\)</span> is different for LSOA- and district-level analysis. In the MSOA-level analysis, there are 6791 spatial units.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The name “negative binomial” is quite difficult to understand in this context. A better, but less popular name, is the gamma-Poisson distribution. Here, the story is simpler: we have a mixture of Poisson distributions where the rate parameters of the Poisson distributions follow a gamma distribution <span class="citation" data-cites="mcelreathStatisticalRethinking2020">(<a href="../references.html#ref-mcelreathStatisticalRethinking2020" role="doc-biblioref">McElreath, 2020</a>)</span>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../Chapters/Chapter3.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../Chapters/Chapter5.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Life expectancy trends in England at the MSOA level</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>